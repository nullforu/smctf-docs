---
title: 19. DB ER 및 마이그레이션
sidebar:
    order: 115
---

SMCTF는 PostgreSQL을 기본 데이터베이스로 사용하며, MySQL 등으로 대체할 수 있습니다. 
다만 프로덕션 환경에선 로컬에서 PostgreSQL을 실행하는 것이 아닌 RDS와 같은 별도의 외부 데이터베이스 서비스를 사용하세요. 

애플리케이션은 Stateless로 설계되었으며, SQLite와 같은 로컬 파일 기반 데이터베이스는 지원하지 않습니다.

DB ER(Entity Relationship)은 아래와 같습니다. 다이어그램이 아닌 Go 코드로 제공하며 참고용으로 제공되며 [nullforu/smctf/internal/models](https://github.com/nullforu/smctf/tree/main/internal/models)에서 확인할 수 있습니다.

```go
type AppConfig struct {
	bun.BaseModel `bun:"table:app_configs"`
	Key           string    `bun:"key,pk,notnull"`
	Value         string    `bun:"value,notnull"`
	UpdatedAt     time.Time `bun:",nullzero,notnull,default:current_timestamp"`
}

type Challenge struct {
	bun.BaseModel   `bun:"table:challenges"`
	ID              int64      `bun:",pk,autoincrement"`
	Title           string     `bun:",notnull"`
	Description     string     `bun:",notnull"`
	Points          int        `bun:",notnull,default:0"`
	MinimumPoints   int        `bun:"minimum_points,notnull,default:0"`
	Category        string     `bun:",notnull"`
	FlagHash        string     `bun:",notnull"`
	FileKey         *string    `bun:"file_key,nullzero"`
	FileName        *string    `bun:"file_name,nullzero"`
	FileUploadedAt  *time.Time `bun:"file_uploaded_at,nullzero"`
	StackEnabled    bool       `bun:"stack_enabled,notnull,default:false"`
	StackTargetPort int        `bun:"stack_target_port,notnull,default:0"`
	StackPodSpec    *string    `bun:"stack_pod_spec,nullzero"`
	IsActive        bool       `bun:",notnull"`
	CreatedAt       time.Time  `bun:",nullzero,notnull,default:current_timestamp"`
	InitialPoints   int        `bun:"-"`
	SolveCount      int        `bun:"-"`
}

type User struct {
	bun.BaseModel `bun:"table:users"`
	ID            int64      `bun:"id,pk,autoincrement"`
	Email         string     `bun:"email,unique,notnull"`
	Username      string     `bun:"username,unique,notnull"`
	PasswordHash  string     `bun:"password_hash,notnull"`
	Role          string     `bun:"role,notnull"`
	TeamID        int64      `bun:"team_id,notnull"`
	TeamName      string     `bun:"team_name,scanonly"`
	BlockedReason *string    `bun:"blocked_reason,nullzero"`
	BlockedAt     *time.Time `bun:"blocked_at,nullzero"`
	CreatedAt     time.Time  `bun:"created_at,nullzero,notnull,default:current_timestamp"`
	UpdatedAt     time.Time  `bun:"updated_at,nullzero,notnull,default:current_timestamp"`
}

type Team struct {
	bun.BaseModel `bun:"table:teams"`
	ID            int64     `bun:",pk,autoincrement"`
	Name          string    `bun:",unique,notnull"`
	CreatedAt     time.Time `bun:",nullzero,notnull,default:current_timestamp"`
}

type Submission struct {
	bun.BaseModel `bun:"table:submissions"`
	ID            int64     `bun:",pk,autoincrement"`
	UserID        int64     `bun:",notnull"`
	ChallengeID   int64     `bun:",notnull"`
	Provided      string    `bun:",notnull"`
	Correct       bool      `bun:",notnull,default:false"`
	IsFirstBlood  bool      `bun:"is_first_blood,notnull,default:false"`
	SubmittedAt   time.Time `bun:",nullzero,notnull,default:current_timestamp"`
}

type RegistrationKey struct {
	bun.BaseModel `bun:"table:registration_keys"`
	ID            int64     `bun:"id,pk,autoincrement"`
	Code          string    `bun:"code,unique,notnull"`
	CreatedBy     int64     `bun:"created_by,notnull"`
	TeamID        int64     `bun:"team_id,notnull"`
	MaxUses       int       `bun:"max_uses,notnull,default:1"`
	UsedCount     int       `bun:"used_count,notnull,default:0"`
	CreatedAt     time.Time `bun:"created_at,nullzero,notnull,default:current_timestamp"`
}

type RegistrationKeyUse struct {
	bun.BaseModel     `bun:"table:registration_key_uses"`
	ID                int64     `bun:"id,pk,autoincrement"`
	RegistrationKeyID int64     `bun:"registration_key_id,notnull"`
	UsedBy            int64     `bun:"used_by,notnull"`
	UsedByIP          string    `bun:"used_by_ip,notnull"`
	UsedAt            time.Time `bun:"used_at,nullzero,notnull,default:current_timestamp"`
}

type Stack struct {
	bun.BaseModel `bun:"table:stacks"`
	ID            int64      `bun:",pk,autoincrement"`
	UserID        int64      `bun:"user_id,notnull"`
	ChallengeID   int64      `bun:"challenge_id,notnull"`
	StackID       string     `bun:"stack_id,notnull"`
	Status        string     `bun:"status,notnull"`
	NodePublicIP  *string    `bun:"node_public_ip,nullzero"`
	NodePort      *int       `bun:"node_port,nullzero"`
	TargetPort    int        `bun:"target_port,notnull"`
	TTLExpiresAt  *time.Time `bun:"ttl_expires_at,nullzero"`
	CreatedAt     time.Time  `bun:",nullzero,notnull,default:current_timestamp"`
	UpdatedAt     time.Time  `bun:",nullzero,notnull,default:current_timestamp"`
}
```

### DB 마이그레이션

SMCTF 환경 변수의 `AUTO_MIGRATE`가 기본적으로 `true`로 설정되어 있어 애플리케이션이 시작될 때 DB 마이그레이션이 자동으로 수행됩니다. 
기존에 데이터가 있는 경우 무시되므로 프로덕션 환경에서도 사용할 수 있습니다. 

애플리케이션 컨셉 자체가 이벤트성으로 단기간 운영되는 CTF 플랫폼이므로, 마이그레이션이 필요하지 않을 가능성이 높습니다. 마이그레이션이 필요한 변경사항이 있는 경우 반드시 기존 데이터베이스를 백업한 후 수동으로 마이그레이션을 수행하세요.
